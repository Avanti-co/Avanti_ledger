<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,viewport-fit=cover,initial-scale=0.93, maximum-scale=0.93, user-scalable=no">
    <title>Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3f72af">

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/service-worker.js")
        .then(reg => console.log("Service worker registered:", reg))
        .catch(err => console.error("Service worker error:", err));
    });
  }
</script>
    <style>
        :root{
            --system-blue: #007AFF;
            --system-red: #FF3B30;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --border-color: #E5E5E5;
            --text-color: #000000;
            --muted-color: #8E8E93;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        body{
            max-width: 100vw;
            margin: 0 auto;
            min-height: 100vh;
            background-color: var(--bg);
            padding-top: 80px;
padding-bottom: 50px;
        }
         .header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:25px 0px 10px 12px;
            background:#3f72af;
            border-bottom:1px solid var(--border-color);
            position:fixed; top:0; z-index:10;
            width: 100%;
        }
        .header a{
            color:#a3c9f1;
            text-decoration:none;
            font-size:1.0rem;
            font-weight:500;
            text-align: left;
        }
        .header-title{
            font-weight:650;
            font-size:1.2rem;
            text-align:center;
            flex:1;
            color:white;
            margin-left: -30px;
        }
        .section-header {
            color: #6d6d72;
            font-size: 14px;
            padding: 10px 18px 5px;
            font-weight: 500;
        }
        .list-item-group {
            background-color: #fff;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 0.5px 0 0 rgba(0, 0, 0, 0.05);
        }
        .ios-toggle input:checked + .slider {
            background-color: #34c759;
        }
        .ios-toggle .slider {
            background-color: #c7c7c7;
            transition: .4s;
        }
        .ios-toggle .slider:before {
            background-color: white;
            transition: .4s;
        }
        .ios-toggle input:checked + .slider:before {
            transform: translateX(1.5rem);
        }
        .delete-account-btn {
            color: var(--system-red) !important;
            font-weight: 400;
        }
        .delete-account-btn:active {
            background-color: var(--system-red) !important;
            color: white !important;
        }
        .hidden-search {
            display: none !important;
        }
        .disabled-link {
            opacity: 0.5;
            pointer-events: none;
            background-color: transparent !important;
        }
        .disabled-link p {
            color: var(--muted-color) !important;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            
            border-radius: 12px;
            width: 100%;
            max-width: 100vw;
        }
        .modal-item-list div {
            padding: 0px 0;
            cursor: pointer;
        }
        .modal-item-list div:not(:last-child) {
            border-bottom: 1px solid #eee;
        }
/* --- iOS Switch Fix --- */

.ios-toggle {
    position: relative;
    display: inline-block;
    width: 45px;
    height: 26px;
}

.ios-toggle input {
    display: none;
}

.ios-toggle .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #c7c7c7;
    border-radius: 34px;
    transition: 0.3s;
}

.ios-toggle .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 2px;
    top: 2px;
    background-color: white;
    border-radius: 50%;
    box-shadow: 0 0 3px rgba(0,0,0,0.3);
    transition: 0.3s;
}

/* Sliding animation */
.ios-toggle input:checked + .slider {
    background-color: #34c759;
}

.ios-toggle input:checked + .slider:before {
    transform: translateX(19px);
}
    </style>
</head>
<body>
<div class="header">
    <a href="#" onclick="history.back(); return false;"><i class="fas fa-chevron-left"></i> Back</a>
    <div class="header-title text-white">Settings</div>
    <div style="width:36px;"></div>
</div>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&display=swap" rel="stylesheet">

<nav style="
    position: fixed; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    
    background: rgba(255, 255, 255, 0.85); 
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px); 
    border-top: 1px solid rgba(0, 0, 0, 0.05); 
    display: flex; 
    justify-content: space-around; 
    align-items: center; 
    z-index: 9999; 
    padding-top: 14px; 
    padding-bottom: constant(safe-area-inset-bottom, 25px);
padding-bottom: env(safe-area-inset-bottom, 25px);
    font-family: 'Inter', sans-serif;
">
    
    <a href="dashboard.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1; transition: 0.2s;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Home</span>
    </a>

    <a href="inventory.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1; position: relative;">
       
        
        <svg style="width: 22px; height: 22px; fill: white; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Inventory</span>
    </a>

    <a href="accounting-report.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Reports</span>
    </a>

    <a href="statistics.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; flex: 1;">
        <svg style="width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 500;">Stats</span>
    </a>

    <a href="settings.html" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #3f72af; flex: 1; position: relative;">
  <div style="position: absolute; top: -14px; width: 20px; height: 3px; background: #3f72af; border-radius: 0 0 4px 4px;"></div>
        <svg style="width: 22px; height: 22px; fill: rgba(37, 99, 235, 0.1); stroke: currentColor; stroke-width: 2;" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <span style="font-size: 11px; margin-top: 4px; font-weight: 600;">Settings</span>
    </a>
</nav>

<div class="settings-container p-4">
    <div class="px-2 mb-6">
        <div class="relative">
            <input type="text" id="search-input" placeholder="Search Settings" class="w-full py-2 pl-10 pr-4 text-base rounded-lg border border-gray-300 focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white" onkeyup="filterSettings()" />
            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>
    </div>
    
    <!-- top profile summary block - give it an id so filter won't accidentally hide it via group logic -->
    <div id="profile-header-group" onclick="location.href='profile.html'"class="list-item-group p-3 mb-6 flex items-center justify-between search-item" data-search-terms="account profile username device status">
        <div class="flex items-center space-x-4">
            <div class="w-14 h-14 bg-gray-200 rounded-full flex items-center justify-center border-2 border-white shadow-inner overflow-hidden" id="profile-icon-container">
                <img id="profile-icon" src="" alt="Profile Icon" class="w-full h-full object-cover hidden" />
                <svg id="profile-icon-svg" class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            </div>
            <div>
                <p class="text-lg font-semibold text-gray-800" id="account-name-display">Loading...</p>
                <p class="text-sm text-gray-500" id="profile-info-display">Username • Admin device</p>
            </div>
        </div>
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
    </div>

    <p class="section-header search-item" data-search-terms="account">ACCOUNT</p>
    <div class="list-item-group">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 active:bg-gray-100 clickable-setting search-item" id="manage-devices-link" data-search-terms="manage devices admins standard">
            <div>
                <p class="text-base text-gray-800">Manage devices</p>
                <p class="text-sm text-gray-500" id="device-counts">loading...</p>
            </div>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>

        <!-- Admin-only switch container -->
        <div id="sync-data-admin-switch-container" class="p-4 border-b border-gray-200 search-item hidden items-center justify-between" data-search-terms="sync data synchronization all">
            <div>
                <p class="text-base text-gray-800">Sync data across all devices</p>
            </div>
           <label class="ios-toggle">
    <input type="checkbox" id="sync-data-switch">
    <span class="slider"></span>
</label>
        </div>

        <!-- Standard devices: sync with a specific device -->
        <div id="sync-data-standard-link-container" class="flex items-center justify-between p-4 border-b border-gray-200 active:bg-gray-100 clickable-setting search-item hidden" data-search-terms="sync data synchronization devices">
            <div>
                <p class="text-base text-gray-800" id="sync-data-label">Sync data with a device</p>
                <p class="text-sm text-gray-500" id="sync-status-display">None</p>
            </div>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
        
        <div class="flex items-center justify-between p-4 border-b border-gray-200 active:bg-gray-100 clickable-setting search-item" id="edit-profile-link" data-search-terms="edit profile">
            <p class="text-base text-gray-800">Edit Profile</p>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>

        <div class="flex items-center justify-between p-4 border-b border-gray-200 active:bg-gray-100 clickable-setting search-item" id="change-password-link" data-search-terms="change password security">
            <p class="text-base text-gray-800">Change Password</p>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>

        <div class="flex items-center justify-between p-4 active:bg-red-50 clickable-setting search-item" id="delete-account-link" data-search-terms="delete account danger zone">
            <p class="text-base delete-account-btn">Delete This Account</p>
        </div>
    </div>

    <p class="section-header search-item" data-search-terms="general">GENERAL</p>
    <div class="list-item-group">
       
        <div class="flex items-center justify-between p-4 border-b border-gray-200 search-item" data-search-terms="generate final accounts gfa">
            <p class="text-base text-gray-800">Generate Final accounts</p>
        <label class="ios-toggle">
    <input type="checkbox" id="gfa-switch">
    <span class="slider"></span>
</label>
        </div>
        <div class="flex items-center justify-between p-4 border-b border-gray-200 active:bg-gray-100 clickable-setting search-item" id="about-link" data-search-terms="about app version">
            <p class="text-base text-gray-800">About</p>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
        <div class="flex items-center justify-between p-4 clickable-setting search-item" id="help-link" data-search-terms="help support faq">
            <p class="text-base text-gray-800">Help</p>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
    </div>

    <div class="list-item-group">
        <div class="flex items-center justify-center p-4 active:bg-gray-100 clickable-setting search-item" id="logout-link" data-search-terms="logout sign out">
            <p class="text-base text-red-500 font-semibold">Log Out</p>
        </div>
    </div>
</div>

<style>
    /* Background overlay */
    #sync-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100%;
        background-color: rgba(0,0,0,0.35);
        display: none;
        justify-content: center;
        align-items: flex-end; /* bottom sheet */
        z-index: 100;
        transition: opacity 0.25s ease;
    }

    /* Bottom-sheet modal content */
    #sync-modal .modal-content {
        width: 100vw;
        background-color: #fff;
        border-radius: 18px 18px 0 0; /* iOS rounded top */
        padding: 20px;
        min-height: 70vh;
        overflow-y: auto;
        margin: -15px;

        /* Start below screen */
        transform: translateY(100%);
        transition: transform 0.35s cubic-bezier(.25,.8,.25,1);
    }

    /* Show state */
    #sync-modal.show {
        display: flex;
        opacity: 1;
    }

    #sync-modal.show .modal-content {
        transform: translateY(0);
    }

    /* Hide (slide down) */
    #sync-modal.hide {
        opacity: 0;
    }

    #sync-modal.hide .modal-content {
        transform: translateY(100%);
    }

    /* Item list styling */
    #sync-modal .modal-item-list div {
        padding: 14px 0;
        cursor: pointer;
        font-size: 16px;
    }

    #sync-modal .modal-item-list div:not(:last-child) {
        

    }
.modal-content::before {
    content: "";
    display: block;
    width: 40px;
    height: 4px;
    background: #c7c7cc;
    border-radius: 2px;
    margin: 6px auto 12px auto;
}

</style>

<div id="sync-modal" class="modal" onclick="closeSyncModal()">
    <div class="modal-content">
        <h3 style="border-bottom: 0.5px solid #d1d1d6; padding-bottom: 5px;"class="text-xl font-semibold mb-4 text-center">Sync Data</h3>

        <p class="text-sm text-gray-600 mb-4 text-center">
            Select a profile to sync with. syncing lets you share the same accounting information with other devices.
        </p>

        <div id="sync-profile-list" class="modal-item-list max-h-60 overflow-y-auto"></div>

        <button 
            onclick="closeSyncModal()" 
            class="w-full mt-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium active:bg-gray-300">
            Cancel
        </button>
    </div>
</div>

<script>
// --- Firebase Initialization ---
const firebaseConfig = {
    apiKey: "AIzaSyDZeQXOHRjhqijerFLyNkOLcbQUIwRLRqY",
  authDomain: "mwelaisha-shaba.firebaseapp.com",
  databaseURL: "https://mwelaisha-shaba-default-rtdb.firebaseio.com",
  projectId: "mwelaisha-shaba",
  storageBucket: "mwelaisha-shaba.firebasestorage.app",
  messagingSenderId: "262165456072",
  appId: "1:262165456072:web:40926b87a0eb513cc971fd",
  measurementId: "G-LVWW6PJ0P0"

};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const database = firebase.database();
const auth = firebase.auth();

// --- Global Variables ---
const accountName = localStorage.getItem('AV_ledger_account_key');
const username = localStorage.getItem('AV_ledger_username');
let currentAuthStatus = 'Admin'; 
let allProfiles = {};
let adminSyncAllActive = false; 

// --- Utility Functions ---
async function getFirebaseData(path) {
    try {
        const snapshot = await database.ref(path).get();
        return snapshot.exists() ? snapshot.val() : null;
    } catch (error) {
        console.error("Firebase read error:", error);
        return null;
    }
}

async function setFirebaseData(path, value) {
    try {
        await database.ref(path).set(value);
    } catch (error) {
        console.error("Firebase write error:", error);
    }
}

async function removeFirebaseData(path) {
    try {
        await database.ref(path).remove();
    } catch (error) {
        console.error("Firebase delete error:", error);
    }
}

async function verifyPassword(password) {
    try {
        if (!accountName) return false;
        const accountData = await getFirebaseData(`accounts/${accountName}`);
        const accountEmail = accountData?.email;
        if (!accountEmail) return false;
        const user = firebase.auth().currentUser;
        if (!user) return false;
        const credential = firebase.auth.EmailAuthProvider.credential(accountEmail, password);
        await user.reauthenticateWithCredential(credential);
        return true;
    } catch (error) {
        return false;
    }
}

// --- UI Restrictions ---
function applyAuthorizationRestrictions() {
    const isStandard = currentAuthStatus === 'Standard';
    const links = ['edit-profile-link', 'change-password-link', 'delete-account-link'];
    links.forEach(id => {
        const el = document.getElementById(id);
        if (el) isStandard ? el.classList.add('disabled-link') : el.classList.remove('disabled-link');
    });
}

// --- Sync Modal & Circular Sync Logic ---
function openSyncModal() {
    if (adminSyncAllActive) {
        alert('Syncing is currently locked by the Admin.');
        return;
    }

    const listContainer = document.getElementById('sync-profile-list');
    listContainer.innerHTML = '';

    for (const profileKey in allProfiles) {
        const profile = allProfiles[profileKey];
        if (profileKey === username) continue;

        const isCurrentlySyncingToThem = !!allProfiles[username]?.syncingTo?.[profileKey];
        
        // Circular Logic: Only check busy status if we are NOT already syncing to them
        const targetIsSyncingToOthers = profile.syncingTo && Object.keys(profile.syncingTo).length > 0;
        const targetIsSyncedWithByOthers = profile.syncingWith && Object.keys(profile.syncingWith).length > 0;

        const statusText = profile.authStatus || 'Standard';
        let availabilityNote = "";
        let isDisabled = false;

        if (!isCurrentlySyncingToThem) {
            if (targetIsSyncingToOthers) {
                availabilityNote = " (Busy: Syncing elsewhere)";
                isDisabled = true;
            } else if (targetIsSyncedWithByOthers) {
                availabilityNote = " (Busy: In use)";
                isDisabled = true;
            }
        }

        const listItem = document.createElement('div');
        listItem.className = `flex justify-between items-center text-gray-800 p-2 ${isDisabled ? 'opacity-40' : 'hover:bg-gray-50'}`;
        listItem.innerHTML = `
            <div>
                <p class="font-medium">${profileKey} <span class="text-xs text-gray-500">(${statusText})${availabilityNote}</span></p>
                <p class="text-xs ${isCurrentlySyncingToThem ? 'text-green-500' : 'text-blue-500'}">
                    ${isCurrentlySyncingToThem ? 'Connected' : 'Available'}
                </p>
            </div>
            <button class="text-sm px-4 py-1 rounded-full ${isCurrentlySyncingToThem ? 'bg-red-500 text-white' : 'bg-blue-500 text-white'}" 
                    ${isDisabled ? 'disabled' : ''}
                    onclick="toggleSync('${profileKey}')">
                ${isCurrentlySyncingToThem ? 'Unsync' : 'Sync'}
            </button>
        `;
        listContainer.appendChild(listItem);
    }

    const modal = document.getElementById('sync-modal');
    modal.style.display = 'flex';
    modal.classList.remove('hide');
    setTimeout(() => modal.classList.add('show'), 10);
}

function closeSyncModal() {
    const modal = document.getElementById('sync-modal');
    modal.classList.remove('show');
    modal.classList.add('hide');
    setTimeout(() => { modal.style.display = 'none'; }, 250);
}

// --- Toggle Sync ---
async function toggleSync(targetProfileKey) {
    if (adminSyncAllActive) return;

    const isCurrentlySyncing = !!allProfiles[username]?.syncingTo?.[targetProfileKey];
    const myPath = `accounts/${accountName}/profiles/${username}/syncingTo/${targetProfileKey}`;
    const targetPath = `accounts/${accountName}/profiles/${targetProfileKey}/syncingWith/${username}`;

    if (isCurrentlySyncing) {
        if (!confirm(`Stop syncing with ${targetProfileKey}?`)) return;
        await removeFirebaseData(myPath);
        await removeFirebaseData(targetPath);
    } else {
        // Multi-sync allowed, no password required for Admins
        await setFirebaseData(myPath, true);
        await setFirebaseData(targetPath, true);
        alert(`Sync established with ${targetProfileKey}.`);
    }
    closeSyncModal();
}

// --- Admin Global Controls ---
async function enableAdminAllSync() {
    if (!confirm('This will force all devices to share data. Continue?')) {
        document.getElementById('sync-data-switch').checked = false;
        return;
    }
    const profileKeys = Object.keys(allProfiles);
    const updates = [];
    for (const pk of profileKeys) {
        updates.push(setFirebaseData(`accounts/${accountName}/profiles/${pk}/savedSyncingTo`, allProfiles[pk].syncingTo || null));
        const allExceptMe = {};
        profileKeys.forEach(other => { if(other !== pk) allExceptMe[other] = true; });
        updates.push(setFirebaseData(`accounts/${accountName}/profiles/${pk}/syncingTo`, allExceptMe));
        updates.push(setFirebaseData(`accounts/${accountName}/profiles/${pk}/syncedWith`, allExceptMe));
    }
    await Promise.all(updates);
    await setFirebaseData(`accounts/${accountName}/settings/synchronization`, 'all');
}

async function disableAdminAllSync() {
    if (!confirm('Restore previous individual sync settings?')) {
        document.getElementById('sync-data-switch').checked = true;
        return;
    }
    const profileKeys = Object.keys(allProfiles);
    const updates = [];
    for (const pk of profileKeys) {
        const saved = allProfiles[pk]?.savedSyncingTo || null;
        updates.push(removeFirebaseData(`accounts/${accountName}/profiles/${pk}/syncingTo`));
        updates.push(removeFirebaseData(`accounts/${accountName}/profiles/${pk}/syncedWith`));
        if (saved) {
            updates.push(setFirebaseData(`accounts/${accountName}/profiles/${pk}/syncingTo`, saved));
            Object.keys(saved).forEach(target => updates.push(setFirebaseData(`accounts/${accountName}/profiles/${target}/syncedWith/${pk}`, true)));
        }
        updates.push(removeFirebaseData(`accounts/${accountName}/profiles/${pk}/savedSyncingTo`));
    }
    await Promise.all(updates);
    await setFirebaseData(`accounts/${accountName}/settings/synchronization`, 'none');
    applyAdminLockUI(false); 
}

function applyAdminLockUI(locked) {
    const container = document.getElementById('sync-data-standard-link-container');
    const display = document.getElementById('sync-status-display');
    if (locked) {
        container.classList.add('disabled-link');
        display.innerText = 'Managed by Admin';
        container.onclick = null;
    } else {
        container.classList.remove('disabled-link');
        const count = Object.keys(allProfiles[username]?.syncingTo || {}).length;
        display.innerText = count ? `${count} devices syncing` : 'None';
        container.onclick = openSyncModal;
    }
}

// --- Data Listeners ---
function loadSettingsData() {
    if (!accountName || !username) return;

    // Profiles & UI Status
    database.ref(`accounts/${accountName}/profiles`).on('value', (snap) => {
        allProfiles = snap.val() || {};
        const me = allProfiles[username];
        currentAuthStatus = me?.authStatus || 'Standard';
        
        let admins = 0, standards = 0;
        Object.values(allProfiles).forEach(p => (p.authStatus === 'Admin' ? admins++ : standards++));

        document.getElementById('profile-info-display').innerText = `${username} • ${currentAuthStatus} device`;
        document.getElementById('device-counts').innerText = `${admins} admins • ${standards} standard devices`;
        
        document.getElementById('sync-data-admin-switch-container').style.display = (currentAuthStatus === 'Admin' ? 'flex' : 'none');
        document.getElementById('sync-data-standard-link-container').style.display = 'flex';

        applyAdminLockUI(adminSyncAllActive);
        applyAuthorizationRestrictions();
    });

    // Global Settings
    database.ref(`accounts/${accountName}/settings`).on('value', (snap) => {
        const settings = snap.val() || {};
        adminSyncAllActive = (settings.synchronization === 'all');
        
        const syncSwitch = document.getElementById('sync-data-switch');
        if (syncSwitch) {
            syncSwitch.checked = adminSyncAllActive;
            syncSwitch.onchange = (e) => e.target.checked ? enableAdminAllSync() : disableAdminAllSync();
        }

        const gfaSwitch = document.getElementById('gfa-switch');
        gfaSwitch.checked = !!settings[username]?.GFA;
        gfaSwitch.onchange = (e) => setFirebaseData(`accounts/${accountName}/settings/${username}/GFA`, e.target.checked);
        
        applyAdminLockUI(adminSyncAllActive);
    });

    // Profile Metadata
    database.ref(`accounts/${accountName}/url`).on('value', (snap) => {
        const url = snap.val();
        const img = document.getElementById('profile-icon');
        const svg = document.getElementById('profile-icon-svg');
        if (url) { img.src = url; img.classList.remove('hidden'); svg.classList.add('hidden'); }
    });

    database.ref(`accounts/${accountName}/displayName`).on('value', (snap) => {
        document.getElementById('account-name-display').innerText = snap.val() || accountName;
    });
}

// --- Event Handlers & Init ---
function filterSettings() {
    const q = document.getElementById('search-input').value.toLowerCase();
    document.querySelectorAll('.search-item').forEach(item => {
        const text = item.textContent.toLowerCase() + (item.getAttribute('data-search-terms') || "").toLowerCase();
        item.classList.toggle('hidden-search', !text.includes(q));
    });
}

document.getElementById('logout-link').onclick = () => { if(confirm('Logout?')) { localStorage.clear(); window.location.href='index.html'; }};
document.getElementById('manage-devices-link').onclick = () => window.location.href='manage-devices.html';
document.getElementById('about-link').onclick = () => window.location.href='about.html';
document.getElementById('help-link').onclick = () => window.location.href='help.html';

['edit-profile-link', 'change-password-link', 'delete-account-link'].forEach(id => {
    document.getElementById(id).onclick = async (e) => {
        if (e.currentTarget.classList.contains('disabled-link')) return alert('Admin access only.');
        if (id === 'edit-profile-link') window.location.href = 'edit-profile.html';
        else if (id === 'change-password-link') window.location.href = 'change-pass.html';
        else {
            if (confirm('Delete everything?') && await verifyPassword(prompt('Enter password:'))) {
                await removeFirebaseData(`accounts/${accountName}`);
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
    };
});

window.toggleSync = toggleSync;
window.closeSyncModal = closeSyncModal;
window.filterSettings = filterSettings;
loadSettingsData();

</script>
<script>
(function () {
    const requiredKeys = [
        'AV_ledger_account_key',
        'AV_ledger_username',
        'AV_ledger_auth_status'
    ];

    const isMissing = requiredKeys.some(key => {
        const value = localStorage.getItem(key);
        return value === null || value === '';
    });

    if (isMissing) {
        // Clear anything partially stored (safety)
        localStorage.clear();

        // Redirect to login
        window.location.replace('index.html');
    }
})();
</script>
</body>
</html>